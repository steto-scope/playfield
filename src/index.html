<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />
    <title>Galois' Playfield</title>
	<script src="js/set.js"></script>
  <script src="js/operation.js"></script>
  <script src="js/field.js"></script>
  <script src="js/htmlgenerator.js"></script>
  <script src="js/jsep/jsep.min.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <link rel="stylesheet" href="playfield.css">
  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  </head>
  <body>
    <div class="main">
      <div class="navi">
        <div class="logo"></div>
        <div class="controls">
          <div class="buttons">
            <input type="button" id="newStructure" value="Neu..."></input>
            <input type="button" id="delStructure" value="-"></input>
          </div>
          <div class="structureSelection">
            <div>
              <select size="10" id="structSelection" onchange="structChanged();"></select>
            </div>
          </div>
          <input type="button" id="aboutButton" value="Über..."></input>
        </div>
      </div>
      <div class="content">

        <div id="maintabs">
          <ul>
            <li><a href="#mainStructureTab">Einstellungen von <span class="structName"></span></a></li>
          </ul>
          <div class="structureTab" id="mainStructureTab">
            <table>
              <tr>
                <td>
                  <fieldset>
                    <legend>Menge von <span class="structName"></span></legend>
                    <div class="fscontent">
                      <span class="ElCaption" id="elementsStr"></span>
                      <br><br>
                      <table>
                        <tr>
                          <th>Mächtigkeit:</th>
                          <td>#<span class="structSetName"></span> = <span class="structSetCard"></span></td>
                        </tr>
                        <tr>
                          <th>Elemente:</th>
                          <td><input type="text" id="elements" size="25"></input></td>
                        </tr>
                        <tr>
                          <th>Mengensymbol:</th>
                          <td><input type="text" id="setSymbol" size="2" maxlength="1"></input></td>
                        </tr>
                      </table>
                    </div>
                  </fieldset>
                </td>
                <td>
                  <fieldset>
                    <legend>Operation <span class="op1name"></span> auf <span class="structSetName"></span></legend>
                    <div class="fscontent">
                      <table>
                        <tr>
                          <th>Operatorsymbol:</th>
                          <td style="vertical-align:top;">
                            <select id="op1symbol">
                              <optgroup label="additiv">
                                <option>⊕</option>
                                <option>⊞</option>
                                <option>⨹</option>
                                <option>-</option>
                                <option>⊖</option>
                                <option>⊟</option>
                                <option>⨺</option>
                              </optgroup>
                              <optgroup label="multiplikativ">
                                <option>⋆</option>
                                <option>×</option>
                                <option>⊛</option>
                                <option>⊗</option>
                                <option>⊠</option>
                                <option>⨻</option>
                                <option>÷</option>
                              </optgroup>
                              <optgroup label="Sonne, Mond und Kringel">
                                <option>∘</option>
                                <option>∙</option>
                                <option>⋅</option>
                                <option>⊙</option>
                                <option>⊚</option>
                                <option>⊡</option>
                                <option>⋄</option>
                              </optgroup>
                            </select>
                          </td>
                        </tr>
                        <tr>
                          <th>JavaScript-Formel:</th>
                          <td style="vertical-align:top;"><input type="text" id="op1formula" size="25"></input><br><input type="button" id="regenerateTable" value="Verknüpfungstabelle neu generieren"></input><br>
                          <span class="footnote">a: Linker Operand<br>b: Rechter Operand<br>n: Mächtigkeit der Menge<br>%: Modulo-Operator</span></td>
                        </tr>
                      </table>
                    </div>
                  </fieldset>
                </td>
                </tr>
                <tr>
                  <td>
                    <fieldset>
                      <legend>Rechnen in <span class="structName"></span></legend>
                      <div class="fscontent">
                        <input type="text" id="calcExpression"></input> <input type="button" id="op1button"></input><br><br>
                        Ergebnis: <span id="calcResult"></span>
                      </div>
                    </fieldset>
                  </td>
                  <td>
                    <div class="opTable" id="op1table"></div>
                  </td>
                </tr>
            </table>
          </div>
        </div>
      </div>
      <div class="newStructure ui-widget" id="createNewDialog" title="Neue Struktur">
        <form>
            <fieldset>
              <p>
              <label for="name">Name: </label>
              <input type="text" name="name" id="name" size="2" value="G" class="text ui-widget-content ui-corner-all">
            </p>
            <p>
              <label for="n">Anzahl Elemente: </label>
              <input id="n" value="2" size="2">
            </p>
            <p>
              <div class="controlgroup" style="display:none;">
                <label for="addop">Addition</label>
                <input type="checkbox" id="addop" name="opgroup" checked>
                <label for="mulop">Multiplikation</label>
                <input type="checkbox" id="mulop" name="opgroup">
              </div>
            </p>
              <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
            </fieldset>
          </form>
      </div>
      <div  class=" ui-widget" id="about" title="Über">
        <h1>Galois' Playfield</h1>
        <br>
        <div style="margin:auto; width:500px;">
          <table>
            <tr>
              <th>Version:</th>
              <td>0.3</td>
            </tr>
            <tr>
              <th>Autor:</th>
              <td>Stefan Tobert</td>
            </tr>
            <tr>
              <th>Lizenz:</th>
              <td>MIT</td>
            </tr>
            <tr>
              <th>Quellcode:</th>
              <td><a href="https://github.com/steto-scope/playfield" target="_blank">https://github.com/steto-scope/playfield</a></td>
            </tr>
            <tr>
            <th>Verwendete Komponenten:</th>
            <td>
              <table>
                <tr>
                  <td><a href="https://jquery.org" target="_blank">jQuery</a></td>
                  <td>v1.12.4</td>
                </tr>
                <tr>
                  <td><a href="https://jqueryui.com" target="_blank">jQuery UI</a></td>
                  <td>v1.12.1</td>
                </tr>
                <tr>
                  <td><a href="https://github.com/soney/jsep" target="_blank">jsep</td>
                  <td>v0.3.2</td>
                </tr>
              </table>
            </td>
          </tr>
          </table>
        </div>
        <br>
        <ul>
          <li>
            <strong>v0.3</strong>
            <ul>
              <li></li>
            </ul>
          </li>
          <li>
            <strong>v0.2</strong>
            <ul>
              <li>Rechnen auf der Struktur</li>
              <li>Editieren der Struktur-Operation</li>
              <li>Editieren der Struktur-Menge</li>
            </ul>
          </li>
          <li>
            <strong>v0.1</strong>
            <ul>
              <li>Anlegen von Strukturen mit 1 Operator</li>
              <li>Grundarchitektur</li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </body>
 <script>


var structureList = [];
var c;
function current() {
  return c;//structureList[document.getElementById('structSelection').value];
}

function nameSuggestion()
{
  var suggestion = "A";
  var used = false;
  do
  {
    used=false;
    for(var i=0; i<structureList.length; i++)
    {
      if(structureList[i].name == suggestion)
        {
          used = true;
          break;
        }
    }
    if(used)
      suggestion = String.fromCharCode(suggestion.charCodeAt()+1);
  }
  while(used);

  return suggestion;
}

function structChanged()
{
  c = structureList[document.getElementById('structSelection').value];
  if($("#structSelection")[0].selectedIndex < 0)
  {
    $("#maintabs").hide();
  }
  else
  {
    $("#maintabs").show();
    updateFields();
  }
}

function updateFields()
{
  var s = current();

  $("#elementsStr")[0].innerHTML = s.set;
  $("#elements")[0].value = s.set.toString("elements");
  $(".structName").html(s.getName());
  $(".structSetName").html(s.set.getSymbol());
  $(".structSetCard").html(s.set.n);
  $("#setSymbol")[0].value = s.set.symbol;
  $(".op1name").html(s.ops[0].symbol);
  $("#op1formula")[0].value = s.ops[0].tableGeneratorCode;
  $("#op1symbol").val(s.ops[0].symbol);
  $("#op1symbol").selectmenu("refresh");
  $("#op1table").html(renderInvTable(s.ops[0],false)+"<br>"+renderTable(s.ops[0],false,false));
  $("#op1button").val(s.ops[0].symbol);
  $("#calcResult").html(current().calculateExpression($("#calcExpression").val()));

}

function sl_addNew(n,name,add,mul)
{
  var m = new Set();
  if((add ^ mul))
  {
    var op = new Operation(m);
    op.tableGeneratorCode = add ? "(a+b)%n" : "(a*b)%n";
    op.symbol = add ? "⊕" : "⊛";
    var g = new Field(m,op);
    g.name = name;
    g.setElements(n);
    structureList.push(g);
  }
  update_sl();
  structChanged();
}

function sl_delete(index)
{
  structureList.splice(index,1);
  update_sl();
  updateFields();
}

function update_sl(selectLast=true) {
  var o = "";
  for(var i=0; i<structureList.length; i++)
  {
    o+='<option value="'+i+'">'+structureList[i]+'</option>';
  }
  document.getElementById('structSelection').innerHTML = o;

  if(selectLast)
  {
    $("#structSelection")[0].selectedIndex = structureList.length-1;
    c = structureList[document.getElementById('structSelection').value];
  }

  if(structureList.length > 0)
  {
    $("#maintabs").show();
    $("#delStructure").prop("disabled",false);
  }
  else
  {
      $("#maintabs").hide();
      $("#delStructure").prop("disabled",true);
  }


}


/* add structure */
 var dialog, form, about;

function addStructure() {
  var name = $( "#name" )[0].value, n = $( "#n" ), addop=$("#addop"), mulop=$("#mulop");
  var valid = true;
  valid = valid && name.trim().length > 0;
  valid = valid && parseInt(n[0].value) >=0 && parseInt(n[0].value) <=32;
  valid = valid && (addop[0].checked || mulop[0].checked);
  if(valid)
  {
    sl_addNew(parseInt(n[0].value),name.trim(),addop[0].checked,mulop[0].checked);

    dialog.dialog("close");
  }
  return valid;
}

dialog = $( "#createNewDialog" ).dialog({
  autoOpen: false,
  modal: true,
  buttons: {
    "Erzeugen": addStructure,
    Cancel: function() {
      dialog.dialog( "close" );
    }
  },
  close: function() {
    form[ 0 ].reset();
  }
});
$( "#createNewDialog" ).on( "dialogopen", function( event, ui ) { $( "#name" )[0].value = nameSuggestion(); } );


form = dialog.find( "form" ).on( "submit", function( event ) {
  event.preventDefault();
  addStructure();
});
$("#n").spinner();
$("#n").spinner('option', 'min',0);
$("#n").spinner('option', 'max',32);
$("#addop").checkboxradio({icon:false});
$("#mulop").checkboxradio({icon:false});
$(".controlgroup").controlgroup();


/* about box */
about = $( "#about" ).dialog({
  autoOpen: false,
  height: 600,
  width: 800,
  modal: true,
  show:'fade',
  buttons: {
    Cancel: function() {
      about.dialog( "close" );
    }
  },
  close: function() {
    form[ 0 ].reset();
  }
});


/* main navigation buttons */
 $("#newStructure").button();
 $("#newStructure").click( function( event )  {
   event.preventDefault();
   dialog.dialog("open");
 } );

 $("#delStructure").button();
 $("#delStructure").click( function( event )  {
   event.preventDefault();
   sl_delete(document.getElementById('structSelection').value);
 } );
 $("#delStructure").prop("disabled",true);

 $("#aboutButton").button();
 $("#aboutButton").click( function( event )  {
   event.preventDefault();
   about.dialog("open");
 } );


 /* main content area */
 $("#maintabs").tabs().hide();

 /* structure tab */
 $("#elements").on( "change", function( event ) {
   current().setElements($(this)[0].value);
   updateFields();
   update_sl(false);
 });
 $("#setSymbol").on( "change", function( event ) {
   current().set.setSymbol($(this)[0].value);
   updateFields();
   update_sl(false);
 });
 $("#op1symbol").selectmenu().selectmenu( "menuWidget" ).addClass("selectdropdown");
  $("#op1symbol").on("selectmenuchange", function( event ) {
   current().ops[0].symbol = ($(this)[0].value);
   updateFields();
   update_sl(false);
 });
 $("#calcExpression").on("keyup", function( event ) {
  $("#calcResult").html(current().calculateExpression($("#calcExpression").val()));
  //updateFields();
});
$("#op1button").on("click",function( event ) {
  var cursorPos = $('#calcExpression').prop('selectionStart');
     var v = $('#calcExpression').val();
     var textBefore = v.substring(0,  cursorPos);
     var textAfter  = v.substring(cursorPos, v.length);
     $('#calcExpression').val(textBefore + $(this).val() + textAfter);
     $('#calcExpression').focus();
})
$("#regenerateTable").on("click",function( event ) {
  current().ops[0].tableGeneratorCode = ($("#op1formula")[0].value);
  current().ops[0].regenerateTable();
 updateFields();
})


 //test
 addStructure();

  </script>
</html>
